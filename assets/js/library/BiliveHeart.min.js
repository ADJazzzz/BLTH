// ==UserScript==
// @name        BiliveHeart
// @namespace   https://github.com/lzghzr/TampermonkeyJS
// @version     0.0.6
// @author      lzghzr
// @description B站直播心跳
// @include     /^https?:\/\/live\.bilibili\.com\/(?:blanc\/)?\d/
// @require     https://gcore.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js
// @license     MIT
// @grant       none
// @run-at      document-end
// ==/UserScript==
class RoomHeart{constructor(t,e=65){this.roomID=t,this.seq_target=e}areaID;parentID;seq=0;seq_target=0;roomID;get id(){return[this.parentID,this.areaID,this.seq,this.roomID]}buvid=this.getItem("LIVE_BUVID");uuid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}));device=[this.buvid,this.uuid];get ts(){return Date.now()}_patchData={};get patchData(){const t=[];for(const[e,s]of Object.entries(this._patchData))t.push(s);return t}get isPatch(){return 0===this.patchData.length?0:1}W="undefined"==typeof unsafeWindow?window:unsafeWindow;ua=this.W&&this.W.navigator?this.W.navigator.userAgent:"";csrf=this.getItem("bili_jct")||"";nextInterval=Math.floor(5)+Math.floor(55*Math.random());heartBeatInterval;secretKey;secretRule;timestamp;lastHeartbeatTimestamp=Date.now();get watchTimeFromLastReport(){const t=Math.ceil(((new Date).getTime()-this.lastHeartbeatTimestamp)/1e3);return t<0?0:t>this.heartBeatInterval?this.heartBeatInterval:t}start(){return this.getInfoByRoom()}doneFunc=function(){};async getInfoByRoom(){if(0===this.roomID)return!1;const t=await fetch(`//api.live.bilibili.com/room/v1/Room/get_info?room_id=${this.roomID}&from=room`,{mode:"cors",credentials:"include"}).then((t=>t.json()));return 0===t.code?(({area_id:this.areaID,parent_area_id:this.parentID,room_id:this.roomID}=t.data),0!==this.areaID&&0!==this.parentID&&(this.e(),!0)):(console.error(GM_info.script.name,`未获取到房间 ${this.roomID} 信息`),!1)}async webHeartBeat(){if(this.seq>this.seq_target)return;const t=`${this.nextInterval}|${this.roomID}|1|0`,e=CryptoJS.enc.Utf8.parse(t),s=CryptoJS.enc.Base64.stringify(e),i=await fetch(`//live-trace.bilibili.com/xlive/rdata-interface/v1/heartbeat/webHeartBeat?hb=${encodeURIComponent(s)}&pf=web`,{mode:"cors",credentials:"include"}).then((t=>t.json()));0===i.code?(this.nextInterval=i.data.next_interval,setTimeout((()=>this.webHeartBeat()),1e3*this.nextInterval)):console.error(GM_info.script.name,`房间 ${this.roomID} 心跳失败`)}async savePatchData(){if(this.seq>this.seq_target)return;const t={id:JSON.stringify(this.id),device:JSON.stringify(this.device),ets:this.timestamp,benchmark:this.secretKey,time:this.watchTimeFromLastReport>this.heartBeatInterval?this.heartBeatInterval:this.watchTimeFromLastReport,ts:this.ts,ua:this.ua},e=this.sypder(JSON.stringify(t),this.secretRule),s=Object.assign({s:e},t);this._patchData[this.roomID]=s,setTimeout((()=>this.savePatchData()),15e3)}async e(){const t={id:JSON.stringify(this.id),device:JSON.stringify(this.device),ts:this.ts,is_patch:0,heart_beat:"[]",ua:this.ua},e=await fetch("//live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/E",{headers:{"content-type":"application/x-www-form-urlencoded"},method:"POST",body:`${this.json2str(t)}&csrf_token=${this.csrf}&csrf=${this.csrf}&visit_id=`,mode:"cors",credentials:"include"}).then((t=>t.json()));0===e.code?(this.seq+=1,({heartbeat_interval:this.heartBeatInterval,secret_key:this.secretKey,secret_rule:this.secretRule,timestamp:this.timestamp}=e.data),setTimeout((()=>this.x()),1e3*this.heartBeatInterval)):console.error(GM_info.script.name,`房间 ${this.roomID} 获取小心心失败`)}async x(){if(this.seq>this.seq_target)return this.doneFunc();const t={id:JSON.stringify(this.id),device:JSON.stringify(this.device),ets:this.timestamp,benchmark:this.secretKey,time:this.heartBeatInterval,ts:this.ts,ua:this.ua},e=this.sypder(JSON.stringify(t),this.secretRule),s=Object.assign({s:e},t);this._patchData[this.roomID]=s,this.lastHeartbeatTimestamp=Date.now();const i=await fetch("//live-trace.bilibili.com/xlive/data-interface/v1/x25Kn/X",{headers:{"content-type":"application/x-www-form-urlencoded"},method:"POST",body:`${this.json2str(s)}&csrf_token=${this.csrf}&csrf=${this.csrf}&visit_id=`,mode:"cors",credentials:"include"}).then((t=>t.json()));0===i.code?(this.seq+=1,({heartbeat_interval:this.heartBeatInterval,secret_key:this.secretKey,secret_rule:this.secretRule,timestamp:this.timestamp}=i.data),setTimeout((()=>this.x()),1e3*this.heartBeatInterval)):console.error(GM_info.script.name,`房间 ${this.roomID} 小心心 心跳失败`)}sypder(t,e){const s=JSON.parse(t),[i,r,a,o]=JSON.parse(s.id),[n,c]=JSON.parse(s.device),h=s.benchmark,m={platform:"web",parent_id:i,area_id:r,seq_id:a,room_id:o,buvid:n,uuid:c,ets:s.ets,time:s.time,ts:s.ts};let d=JSON.stringify(m);for(const t of e)switch(t){case 0:d=CryptoJS.HmacMD5(d,h).toString(CryptoJS.enc.Hex);break;case 1:d=CryptoJS.HmacSHA1(d,h).toString(CryptoJS.enc.Hex);break;case 2:d=CryptoJS.HmacSHA256(d,h).toString(CryptoJS.enc.Hex);break;case 3:d=CryptoJS.HmacSHA224(d,h).toString(CryptoJS.enc.Hex);break;case 4:d=CryptoJS.HmacSHA512(d,h).toString(CryptoJS.enc.Hex);break;case 5:d=CryptoJS.HmacSHA384(d,h).toString(CryptoJS.enc.Hex);break;default:break}return d}getItem(t){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||""}json2str(t){let e="";for(const s in t)e+=`${s}=${encodeURIComponent(t[s])}&`;return e.slice(0,-1)}}