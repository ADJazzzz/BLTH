// ==UserScript==
// @name        libBilibiliToken
// @namespace   https://github.com/lzghzr/TampermonkeyJS
// @version     1.0.0
// @author      lzghzr
// @description 哔哩哔哩cookie获取token
// @match       *://*.bilibili.com/*
// @connect     passport.bilibili.com
// @license     MIT
// @grant       GM_xmlhttpRequest
// @grant       unsafeWindow
// @run-at      document-start
// ==/UserScript==
class BilibiliToken{static _W="undefined"==typeof unsafeWindow?window:unsafeWindow;static __loginSecretKey="2653583c8873dea268ab9386918b1d65";static loginAppKey="783bbb7264451d82";static __secretKey="560c52ccd288fed045859ed18bffd973";static appKey="1d8b6e7d45233436";build="6720300";buvid=BilibiliToken.buvidXX;Clocale="zh-Hans_CN";channel="website";localId=this.buvid;mobiApp="android";platform="android";Slocale="zh-Hans_CN";static get buvidXX(){const e=this.md5(Math.random().toString()).toUpperCase();return"XX"+e[2]+e[12]+e[22]+e}static get TS(){return Math.floor(Date.now()/1e3)}headers={"user-agent":"Mozilla/5.0 BiliDroid/6.72.0 (bbcallen@gmail.com) os/android model/XQ-CT72 mobi_app/android build/6720300 channel/bilih5 innerVer/6720310 osVer/12 network/2",buvid:this.buvid};get loginQuery(){return`appkey=${BilibiliToken.loginAppKey}&build=${this.build}&c_locale=${this.Clocale}&channel=${this.channel}&local_id=${this.localId}  &mobi_app=${this.mobiApp}&platform=${this.platform}&s_locale=${this.Slocale}`}static signQuery(e,o=!0,t=this.__secretKey){let n=e;o&&(n=`${e}&ts=${this.TS}`),n=n.split("&").sort().join("&");const i=n+t;return`${n}&sign=${this.md5(i)}`}signLoginQuery(e){const o=void 0===e?this.loginQuery:`${e}&${this.loginQuery}`;return BilibiliToken.signQuery(o,!0,BilibiliToken.__loginSecretKey)}async getAuthCode(){const e=await BilibiliToken.XHR({GM:!0,anonymous:!0,method:"POST",url:"https://passport.bilibili.com/x/passport-tv-login/qrcode/auth_code",data:this.signLoginQuery(),responseType:"json",headers:this.headers});return void 0!==e&&200===e.response.status&&0===e.body.code?e.body.data.auth_code:console.error(GM_info.script.name,"getAuthCode",e)}async qrcodeConfirm(e,o){const t=await BilibiliToken.XHR({GM:!0,method:"POST",url:"https://passport.bilibili.com/x/passport-tv-login/h5/qrcode/confirm",data:`auth_code=${e}&csrf=${o}&scanning_type=1`,responseType:"json",headers:this.headers});return void 0!==t&&200===t.response.status&&0===t.body.code?t.body.data.gourl:console.error(GM_info.script.name,"qrcodeConfirm",t)}async qrcodePoll(e){const o=await BilibiliToken.XHR({GM:!0,anonymous:!0,method:"POST",url:"https://passport.bilibili.com/x/passport-tv-login/qrcode/poll",data:this.signLoginQuery(`auth_code=${e}`),responseType:"json",headers:this.headers});return void 0!==o&&200===o.response.status&&0===o.body.code?o.body.data:console.error(GM_info.script.name,"qrcodePoll",o)}async getToken(){const e=BilibiliToken._W.document.cookie.match(/bili_jct=(?<csrf>.*?);/);if(null===e||void 0===e.groups)return console.error(GM_info.script.name,"getToken","cookie获取失败");const o=e.groups.csrf,t=await this.getAuthCode();if(void 0===t)return;if(void 0===await this.qrcodeConfirm(t,o))return;const n=await this.qrcodePoll(t);return void 0!==n?n:void 0}static md5(e,o,t){return function(e,o,t){if(!o)return t?f(e):h(f(e));if(!t)return h(b(o,e));return b(o,e)}(e,o,t);function n(e,o){var t=(65535&e)+(65535&o);return(e>>16)+(o>>16)+(t>>16)<<16|65535&t}function i(e,o,t,i,r,s){return n((a=n(n(o,e),n(i,s)))<<(d=r)|a>>>32-d,t);var a,d}function r(e,o,t,n,r,s,a){return i(o&t|~o&n,e,o,r,s,a)}function s(e,o,t,n,r,s,a){return i(o&n|t&~n,e,o,r,s,a)}function a(e,o,t,n,r,s,a){return i(o^t^n,e,o,r,s,a)}function d(e,o,t,n,r,s,a){return i(t^(o|~n),e,o,r,s,a)}function c(e,o){var t,i,c,l,u;e[o>>5]|=128<<o%32,e[14+(o+64>>>9<<4)]=o;var h=1732584193,p=-271733879,f=-1732584194,b=271733878;for(t=0;t<e.length;t+=16)i=h,c=p,l=f,u=b,h=r(h,p,f,b,e[t],7,-680876936),b=r(b,h,p,f,e[t+1],12,-389564586),f=r(f,b,h,p,e[t+2],17,606105819),p=r(p,f,b,h,e[t+3],22,-1044525330),h=r(h,p,f,b,e[t+4],7,-176418897),b=r(b,h,p,f,e[t+5],12,1200080426),f=r(f,b,h,p,e[t+6],17,-1473231341),p=r(p,f,b,h,e[t+7],22,-45705983),h=r(h,p,f,b,e[t+8],7,1770035416),b=r(b,h,p,f,e[t+9],12,-1958414417),f=r(f,b,h,p,e[t+10],17,-42063),p=r(p,f,b,h,e[t+11],22,-1990404162),h=r(h,p,f,b,e[t+12],7,1804603682),b=r(b,h,p,f,e[t+13],12,-40341101),f=r(f,b,h,p,e[t+14],17,-1502002290),h=s(h,p=r(p,f,b,h,e[t+15],22,1236535329),f,b,e[t+1],5,-165796510),b=s(b,h,p,f,e[t+6],9,-1069501632),f=s(f,b,h,p,e[t+11],14,643717713),p=s(p,f,b,h,e[t],20,-373897302),h=s(h,p,f,b,e[t+5],5,-701558691),b=s(b,h,p,f,e[t+10],9,38016083),f=s(f,b,h,p,e[t+15],14,-660478335),p=s(p,f,b,h,e[t+4],20,-405537848),h=s(h,p,f,b,e[t+9],5,568446438),b=s(b,h,p,f,e[t+14],9,-1019803690),f=s(f,b,h,p,e[t+3],14,-187363961),p=s(p,f,b,h,e[t+8],20,1163531501),h=s(h,p,f,b,e[t+13],5,-1444681467),b=s(b,h,p,f,e[t+2],9,-51403784),f=s(f,b,h,p,e[t+7],14,1735328473),h=a(h,p=s(p,f,b,h,e[t+12],20,-1926607734),f,b,e[t+5],4,-378558),b=a(b,h,p,f,e[t+8],11,-2022574463),f=a(f,b,h,p,e[t+11],16,1839030562),p=a(p,f,b,h,e[t+14],23,-35309556),h=a(h,p,f,b,e[t+1],4,-1530992060),b=a(b,h,p,f,e[t+4],11,1272893353),f=a(f,b,h,p,e[t+7],16,-155497632),p=a(p,f,b,h,e[t+10],23,-1094730640),h=a(h,p,f,b,e[t+13],4,681279174),b=a(b,h,p,f,e[t],11,-358537222),f=a(f,b,h,p,e[t+3],16,-722521979),p=a(p,f,b,h,e[t+6],23,76029189),h=a(h,p,f,b,e[t+9],4,-640364487),b=a(b,h,p,f,e[t+12],11,-421815835),f=a(f,b,h,p,e[t+15],16,530742520),h=d(h,p=a(p,f,b,h,e[t+2],23,-995338651),f,b,e[t],6,-198630844),b=d(b,h,p,f,e[t+7],10,1126891415),f=d(f,b,h,p,e[t+14],15,-1416354905),p=d(p,f,b,h,e[t+5],21,-57434055),h=d(h,p,f,b,e[t+12],6,1700485571),b=d(b,h,p,f,e[t+3],10,-1894986606),f=d(f,b,h,p,e[t+10],15,-1051523),p=d(p,f,b,h,e[t+1],21,-2054922799),h=d(h,p,f,b,e[t+8],6,1873313359),b=d(b,h,p,f,e[t+15],10,-30611744),f=d(f,b,h,p,e[t+6],15,-1560198380),p=d(p,f,b,h,e[t+13],21,1309151649),h=d(h,p,f,b,e[t+4],6,-145523070),b=d(b,h,p,f,e[t+11],10,-1120210379),f=d(f,b,h,p,e[t+2],15,718787259),p=d(p,f,b,h,e[t+9],21,-343485551),h=n(h,i),p=n(p,c),f=n(f,l),b=n(b,u);return[h,p,f,b]}function l(e){var o,t="",n=32*e.length;for(o=0;o<n;o+=8)t+=String.fromCharCode(e[o>>5]>>>o%32&255);return t}function u(e){var o,t=[];for(t[(e.length>>2)-1]=void 0,o=0;o<t.length;o+=1)t[o]=0;var n=8*e.length;for(o=0;o<n;o+=8)t[o>>5]|=(255&e.charCodeAt(o/8))<<o%32;return t}function h(e){var o,t,n="0123456789abcdef",i="";for(t=0;t<e.length;t+=1)o=e.charCodeAt(t),i+=n.charAt(o>>>4&15)+n.charAt(15&o);return i}function p(e){return unescape(encodeURIComponent(e))}function f(e){return function(e){return l(c(u(e),8*e.length))}(p(e))}function b(e,o){return function(e,o){var t,n,i=u(e),r=[],s=[];for(r[15]=s[15]=void 0,i.length>16&&(i=c(i,8*e.length)),t=0;t<16;t+=1)r[t]=909522486^i[t],s[t]=1549556828^i[t];return n=c(r.concat(u(o)),512+8*o.length),l(c(s.concat(n),640))}(p(e),p(o))}}static XHR(e){return new Promise((o=>{const t=e=>{console.error(GM_info.script.name,e),o(void 0)};if(e.GM)"POST"===e.method&&(void 0===e.headers&&(e.headers={}),void 0===e.headers["Content-Type"]&&(e.headers["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8")),e.timeout=3e4,e.onload=e=>o({response:e,body:e.response}),e.onerror=t,e.ontimeout=t,GM_xmlhttpRequest(e);else{const n=new XMLHttpRequest;n.open(e.method,e.url),"POST"===e.method&&null===n.getResponseHeader("Content-Type")&&n.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=utf-8"),e.withCredentials&&(n.withCredentials=!0),void 0!==e.responseType&&(n.responseType=e.responseType),n.timeout=3e4,n.onload=e=>{const t=e.target;o({response:t,body:t.response})},n.onerror=t,n.ontimeout=t,n.send(e.data)}}))}}