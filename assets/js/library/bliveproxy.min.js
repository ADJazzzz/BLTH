// ==UserScript==
// @name         bliveproxy
// @namespace    http://tampermonkey.net/
// @version      0.5
// @description  B站直播websocket hook框架
// @author       xfgryujk
// @include      /https?:\/\/live\.bilibili\.com\/?\??.*/
// @include      /https?:\/\/live\.bilibili\.com\/\d+\??.*/
// @include      /https?:\/\/live\.bilibili\.com\/(blanc\/)?\d+\??.*/
// @run-at       document-start
// @require      https://gcore.jsdelivr.net/gh/google/brotli@5692e422da6af1e991f9182345d58df87866bc5e/js/decode.js
// @grant        none
// ==/UserScript==
!function(){let e=window;"undefined"!=typeof unsafeWindow&&(e=unsafeWindow);let t=new TextEncoder,n=new TextDecoder;let r={addCommandHandler(e,t){let n=this._commandHandlers[e];n||(n=this._commandHandlers[e]=[]),n.push(t)},removeCommandHandler(e,t){let n=this._commandHandlers[e];n&&(this._commandHandlers[e]=n.filter((e=>e!==t)))},hook(){e.WebSocket=new Proxy(e.WebSocket,{construct(e,t){let n=new e(...t);return new Proxy(n,a)}})},_commandHandlers:{},_getCommandHandlers(e){return this._commandHandlers[e]||null}},a={get(e,t){let n=e[t];return"function"==typeof n&&(n=n.bind(e)),n},set(e,t,n){if("onmessage"===t){let e=n;n=function(t){!function(e,t){if(!(e.data instanceof ArrayBuffer))return void t(e);function n(n){t({...e,data:n})}o(new Uint8Array(e.data),n)}(t,e)}}return e[t]=n,n}};function i(e,t){let n=16+e.byteLength,r=new ArrayBuffer(n),a=3===t?1:0,i=new DataView(r);i.setUint32(0,n),i.setUint16(4,16),i.setUint16(6,a),i.setUint32(8,t),i.setUint32(12,1);let o=new Uint8Array(r,16,e.byteLength);for(let t=0;t<e.byteLength;t++)o[t]=e[t];return r}function o(e,t){let r=new DataView(e.buffer),a=r.getUint32(8);switch(a){case 8:case 5:{let r=0;for(;r<e.byteLength;){let a=new DataView(e.buffer,r),f=a.getUint32(0),l=a.getUint16(4),s=a.getUint16(6),c=a.getUint32(8),u=new Uint8Array(e.buffer,r+l,f-l);if(5===c)switch(s){case 0:u=n.decode(u),u=JSON.parse(u),d(u,t);break;case 3:u=BrotliDecode(u),o(u,t);break;default:t(i(u,c));break}else{t(i(u,c))}r+=f}break}default:{let n=r.getUint32(0),o=r.getUint16(4);t(i(new Uint8Array(e.buffer,o,n-o),a));break}}}function d(e,n){if(e instanceof Array){for(let t of e)this.handleCommand(t);return}let a=e.cmd||"",o=a.indexOf(":");-1!=o&&(a=a.substr(0,o));let d=r._getCommandHandlers(a);if(d)for(let t of d)t(e);let f=function(e){return i(t.encode(JSON.stringify(e)),5)}(e);n(f)}e.bliveproxy||(e.bliveproxy=r)}();