// ==UserScript==
// @name        Ajax-hook
// @namespace   https://github.com/wendux/Ajax-hook
// @version     2.1.3
// @author      wendux
// @description Ajax-hook source code: https://github.com/wendux/Ajax-hook
// @match       *://*/*
// @run-at      document-start
// ==/UserScript==
const ah=(t=>{var e=["load","loadend","timeout","error","readystatechange","abort"];function r(t,e){var r={};for(var n in t)r[n]=t[n];return r.target=r.currentTarget=e,r}function n(n,o){function s(t){return function(){var e=this.hasOwnProperty(t+"_")?this[t+"_"]:this.xhr[t],r=(n[t]||{}).getter;return r&&r(e,this)||e}}function i(t){return function(e){var o=this.xhr,s=this,i=n[t];if("on"===t.substring(0,2))s[t+"_"]=e,o[t]=function(i){i=r(i,s),n[t]&&n[t].call(s,o,i)||e.call(s,i)};else{var a=(i||{}).setter;e=a&&a(e,s)||e,this[t+"_"]=e;try{o[t]=e}catch(t){}}}}function a(t){return function(){var e=[].slice.call(arguments);if(n[t]){var r=n[t].call(this,e,this.xhr);if(r)return r}return this.xhr[t].apply(this.xhr,e)}}return(o=o||t).__xhr=o.__xhr||o.XMLHttpRequest,o.XMLHttpRequest=function(){for(var t=new o.__xhr,r=0;r<e.length;++r){var n="on"+e[r];void 0===t[n]&&(t[n]=null)}for(var u in t){var c="";try{c=typeof t[u]}catch(t){}"function"===c?this[u]=a(u):Object.defineProperty(this,u,{get:s(u),set:i(u),enumerable:!0})}var f=this;t.getProxy=function(){return f},this.xhr=t},Object.assign(o.XMLHttpRequest,{UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4}),o.__xhr}function o(e){(e=e||t).__xhr&&(e.XMLHttpRequest=e.__xhr),e.__xhr=void 0}var s=e[0],i=e[1],a=e[2],u=e[3],c=e[4],f=e[5];function h(t){return t.watcher||(t.watcher=document.createElement("a"))}function d(t,e){var n,o=t.getProxy(),s="on"+e+"_",i=r({type:e},o);o[s]&&o[s](i),"function"==typeof Event?n=new Event(e,{bubbles:!1}):(n=document.createEvent("Event")).initEvent(e,!1,!0),h(t).dispatchEvent(n)}function v(t){this.xhr=t,this.xhrProxy=t.getProxy()}function l(t){function e(t){v.call(this,t)}return e.prototype=Object.create(v.prototype),e.prototype.next=t,e}v.prototype=Object.create({resolve:function(t){var e=this.xhrProxy,r=this.xhr;e.readyState=4,r.resHeader=t.headers,e.response=e.responseText=t.response,e.statusText=t.statusText,e.status=t.status,d(r,c),d(r,s),d(r,i)},reject:function(t){this.xhrProxy.status=0,d(this.xhr,t.type),d(this.xhr,i)}});var p=l((function(t){var e=this.xhr;for(var r in t=t||e.config,e.withCredentials=t.withCredentials,e.open(t.method,t.url,!1!==t.async,t.user,t.password),t.headers)e.setRequestHeader(r,t.headers[r]);e.send(t.body)})),x=l((function(t){this.resolve(t)})),y=l((function(t){this.reject(t)}));return{proxy:function(o,s){if((s=s||t).__xhr)throw"Ajax is already hooked.";return function(t,o){var s=t.onRequest,i=t.onResponse,v=t.onError;function l(t,e){var r=new x(t),n={response:e.response||e.responseText,status:e.status,statusText:e.statusText,config:t.config,headers:t.resHeader||t.getAllResponseHeaders().split("\r\n").reduce((function(t,e){if(""===e)return t;var r=e.split(":");return t[r.shift()]=function(t){return t.replace(/^\s+|\s+$/g,"")}(r.join(":")),t}),{})};if(!i)return r.resolve(n);i(n,r)}function g(t,e,r,n){var o=new y(t);r={config:t.config,error:r,type:n},v?v(r,o):o.next(r)}function _(){return!0}function w(t){return function(e,r){return g(e,this,r,t),!0}}function E(t,e){return 4===t.readyState&&0!==t.status?l(t,e):4!==t.readyState&&d(t,c),!0}return n({onload:_,onloadend:_,onerror:w(u),ontimeout:w(a),onabort:w(f),onreadystatechange:function(t){return E(t,this)},open:function(t,e){var r=this,n=e.config={headers:{}};n.method=t[0],n.url=t[1],n.async=t[2],n.user=t[3],n.password=t[4],n.xhr=e;var o="on"+c;if(e[o]||(e[o]=function(){return E(e,r)}),s)return!0},send:function(t,e){var r=e.config;if(r.withCredentials=e.withCredentials,r.body=t[0],s){var n=function(){s(r,new p(e))};return!1===r.async?n():setTimeout(n),!0}},setRequestHeader:function(t,e){if(e.config.headers[t[0].toLowerCase()]=t[1],s)return!0},addEventListener:function(t,n){var o=this;if(-1!==e.indexOf(t[0])){var s=t[1];return h(n).addEventListener(t[0],(function(e){var n=r(e,o);n.type=t[0],n.isTrusted=!0,s.call(o,n)})),!0}},getAllResponseHeaders:function(t,e){var r=e.resHeader;if(r){var n="";for(var o in r)n+=o+": "+r[o]+"\r\n";return n}},getResponseHeader:function(t,e){var r=e.resHeader;if(r)return r[(t[0]||"").toLowerCase()]}},o)}(o,s)},unProxy:function(t){o(t)},hook:n,unHook:o}})("undefined"==typeof unsafeWindow?window:unsafeWindow);